<!DOCTYPE html>
<html>
    
    <head>
        <title>添加资讯</title>
        <!-- Bootstrap -->
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
        <link href="assets/styles.css" rel="stylesheet" media="screen">
        <link href="assets/DT_bootstrap.css" rel="stylesheet" media="screen">
        <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="vendors/flot/excanvas.min.js"></script><![endif]-->
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <script src="vendors/modernizr-2.6.2-respond-1.1.0.min.js"></script>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
          <script src="../js/args.js"></script>
        <script>
        	if (!getCookie("adminname") || getCookie("adminname") == ""){
        		window.location = "login.html";
        	}
        	var hh = location.search;
        	if (!hh || hh == ""){
        		alert("参数错误");
        	}
        	var tArr=hh.split("#");//防止页面意外加了#
        	var pType="";
        	var pId = "";
        	if (tArr.length >0){
        		var pArr=tArr[0].split("&");
        		if (pArr.length == 2){
        			pType = pArr[0].replace("?","");
        			pId = pArr[1];
        		}else if (pArr.length==1){
        			pType = pArr[0].replace("?","");
        		}
        	}
        </script>
    </head>
    
    <body>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span>
                     <span class="icon-bar"></span>
                     <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="#">后台管理</a>
                    <script src="top.js"></script>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span3" id="sidebar">
                    <ul class="nav nav-list bs-docs-sidenav nav-collapse collapse">
                         <script type="text/javascript" src="menus.js" ></script>
                    </ul>
                </div>
                <!--/span-->
                <div class="span9" id="content">

                     <div class="row-fluid">
                        <!-- block -->
                        <div class="block">
                            <div class="navbar navbar-inner block-header">
                                <div class="muted pull-left">
                                	内容编辑
                                </div>
                            </div>
                            <div class="block-content collapse in">
                                <div class="span12">
                                    <form class="form-horizontal">
                                      <fieldset>
                                        <legend>
                                        	<script>
	                                			switch(pType){
		                                			case "1":document.write("头条新闻");break;
		                                			case "2":document.write("");break;
		                                			case "3":document.write("会员交流(密)");break;
		                                			case "4":document.write("参赛必读(密)");break;
		                                		}
		                                	</script>
                                        </legend>
                                        <div class="control-group rowTitle">
                                          <label class="control-label" for="typeahead">引题</label>
                                          <div class="controls">
                                            <input type="text" class="span6" id="txtEyebrow" data-items="4" >
                                            <p class="help-block">不要超过50个字</p>
                                          </div>
                                        </div>
                                        <div class="control-group rowTitle">
                                          <label class="control-label" for="typeahead">标题</label>
                                          <div class="controls">
                                            <input type="text" class="span6" id="txtTitle" data-items="4" >
                                            <p class="help-block">不要超过50个字，必填</p>
                                          </div>
                                        </div>
                                        <div class="control-group rowSummary">
                                          <label class="control-label" for="typeahead">副标题</label>
                                          <div class="controls">
                                            <input type="text" class="span6" id="txtSummary" data-items="4" >
                                            <p class="help-block">不要超过200个字，不填写，前台将不显示</p>
                                          </div>
                                        </div>
                                        <div class="control-group rowAuthor">
                                          <label class="control-label" for="typeahead">作者</label>
                                          <div class="controls">
                                            <input type="text" class="span6" id="txtAuthor" data-items="4" >
                                            <p class="help-block">与来源字段二填一即可</p>
                                          </div>
                                        </div>
                                        <div class="control-group rowAuthor">
                                          <label class="control-label" for="typeahead">来源</label>
                                          <div class="controls">
                                            <input type="text" class="span6" id="txtSource" data-items="4" >
                                            <p class="help-block">与作者字段二填一即可</p>
                                          </div>
                                        </div>
                                        <div class="control-group rowInterpreter">
                                          <label class="control-label" for="typeahead">翻译</label>
                                          <div class="controls">
                                            <input type="text" class="span6" id="txtInterpreter" data-items="4" >
                                            <p class="help-block">填写翻译人员的称呼</p>
                                          </div>
                                        </div>
                                        <div class="control-group rowEditor">
                                          <label class="control-label" for="typeahead">编辑</label>
                                          <div class="controls">
                                            <input type="text" class="span6" id="txtEditor" data-items="4" >
                                            <p class="help-block">如果不填，前台将显示：本站编辑</p>
                                          </div>
                                        </div>
                                        <div class="control-group rowContent">
                                          <div >
                                            <!--<textarea class="input-xlarge textarea" placeholder="内容编辑区 ..." style=" width: 900px; height: 400px"></textarea>-->
                                          
                                          	<div id="alerts"></div>
										<textarea id="editor" name="content" style="width:800px;height:500px;"></textarea>

                                          </div>
                                        </div>
                                        <div class="control-group rowIstop">
                                          <label class="control-label" for="optionsCheckbox">是否置顶</label>
                                          <div class="controls">
                                            <label class="uniform">
                                              <input class="" type="checkbox" id="chkIstop">
                                                                                            勾选后，本条信息将置顶
                                            </label>
                                          </div>
                                        </div>
                                        <!--<div class="control-group rowExpdate">
                                          <label class="control-label" for="date01">截止日期</label>
                                          <div class="controls">
                                            <input type="text" class="input-xlarge datepicker" id="txtExpdate" value="">
                                            <p class="help-block">投稿的最后期限</p>
                                          </div>
                                        </div>-->
                                        
                                        <div class="form-actions">
                                          <button type="button" class="btn btn-primary" onclick="doSave();">保 存</button>
                                          <button type="button" class="btn" onclick="doBack()">返回</button>
                                        </div>
                                      </fieldset>
                                    </form>

                                </div>
                            </div>
                        </div>
                        <!-- /block -->
                    </div>
                    
                </div>
            </div>
            <hr>
            <footer>
                <p>&copy; Vincent Gabriel 2013</p>
            </footer>
        </div>
        <!--/.fluid-container-->

        <!--/.fluid-container-->
        <link href="external/google-code-prettify/prettify.css" rel="stylesheet">
<link href="external/no-icon.min.css" rel="stylesheet">

 <link href="vendors/datepicker.css" rel="stylesheet" media="screen">
        <link href="vendors/uniform.default.css" rel="stylesheet" media="screen">
        <link href="vendors/chosen.min.css" rel="stylesheet" media="screen">

        <link href="http://cdn.bootcss.com/bootstrap/2.3.2/css/bootstrap-responsive.min.css" rel="stylesheet">
<link href="http://cdn.bootcss.com/font-awesome/3.0.2/css/font-awesome.css" rel="stylesheet">
<script src="http://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
        <script src="http://cdn.bootcss.com/bootstrap/2.3.1/js/bootstrap.min.js"></script>
        
        
		<link rel="stylesheet" href="../themes/default/default.css" />
		<script src="../kindeditor/kindeditor-all.js"></script>
		<script charset="utf-8" src="../kindeditor/lang/zh-CN.js"></script>
		
        <script>
        	var editorObj;
        KindEditor.ready(function(K) {
                editorObj = K.create('#editor', {
                        langType : 'zh-CN',
                        uploadJson : '../PsaBackend/upload_json.jsp',
            				fileManagerJson : '../PsaBackend/file_manager_json.jsp',
            				allowFileManager : true
//          				afterUpload : function(url) {
//	                        alert(url);
//	                		}
                });
                ///PsaBackend/upload_json.jsp
        });

	var infoObj = {};
	var loadOneNews = function(){
		infoObj.oid=pId;
		$.ajax({
            url:"/PsaBackend/News/GetOne/"+pId,  
            type:"GET",  
            dataType:"json",  
            contentType: "application/json; charset=utf-8",
            async:false,  
//          data:JSON.stringify(pData),
            success:function(data){
            	if (data && data.title){
            		$("#txtTitle").val(data.title);
					$("#txtSummary").val(data.summary);
					$("#txtAuthor").val(data.author);
					$("#txtEditor").val(data.editor);
					$('#editor').html(data.content);
					if (data.isTop == 1)$("#chkIstop").attr("checked","true") ;
					$("#txtSource").val(data.source);
					$("#txtEyebrow").val(data.eyebrow);
					$("#txtInterpreter").val(data.interpreter);
					
					loadPicDblFun();
//					if(data.expDate != "") $("#txtExpdate").val( (new Date(data.expDate)).Format("MM/dd/yyyy") );
            	}else{
            		alert("加载数据失败");
            	}
            },  
            error:function(){
            	alert("加载数据失败");
            }
        });  
	};
	
	var doBack=function(){
		location = "news.html?"+pType;
	};
	var doSave=function(){	
		var ctypeInt = 0;
		try{
			ctypeInt = parseInt(pType);
		}catch(e){
			alert("类型错误");
			return;
		}
		
		infoObj.title=$("#txtTitle").val();
		infoObj.summary=$("#txtSummary").val();
		infoObj.author=$("#txtAuthor").val();
		infoObj.editor=$("#txtEditor").val();
		infoObj.content = editorObj.html();
		infoObj.isTop = ($('#chkIstop').get(0).checked)?1:0;
		infoObj.ctype = ctypeInt;
		infoObj.eyebrow = $("#txtEyebrow").val();
		infoObj.source = $("#txtSource").val();
		infoObj.interpreter = $("#txtInterpreter").val();
//		infoObj.expDate = ($("#txtExpdate").val()=="")?0:new Date($("#txtExpdate").val()).getTime();
		if (infoObj.title == ""){
			alert("标题不能为空");
			return ;
		}
		$.ajax({
            url:"/PsaBackend/News/AddNew",  
            type:"POST",  
            dataType:"json",  
            contentType: "application/json; charset=utf-8",
            async:false,  
            data:JSON.stringify(infoObj),  
            success:function(data){
            	if (data && data.code && data.code == 1){
            		alert("保存成功");
            	}else{
            		alert("提交失败");
            	}
            },  
            error:function(){
            	alert("提交失败");
            }
        });  
	}
        $(function() {
            //通过类型决定加载字段
			if (pType != "4"){
				$(".rowInterpreter").hide();
			}else{
				$(".rowExpdate").hide();
			}
            if (pId != ""){
				loadOneNews();
            }
		 	$('#editor').html($('#Content').val());
        });
        
       </script>
    </body>

</html>